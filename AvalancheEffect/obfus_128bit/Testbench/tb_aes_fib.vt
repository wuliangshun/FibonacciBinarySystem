include "timescale.v";

module tb_aes_fib;
reg	    [127:0] text_in;
reg     [127:0] key;
wire	[127:0]	text_out;
wire	done;
reg clk;   
reg kld;
reg rst;      //0:reset
reg sel;     //1:encode
reg ld;

reg [127:0] base_input;
reg [127:0] base_output;
reg [127:0] temp;
reg [7:0] cnt;

reg [127:0] mem_1[16:0];
reg [127:0] mem_2[16:0];
reg [127:0] mem_3[16:0];
reg [127:0] mem_4[16:0];
reg [127:0] mem_5[16:0];
reg [127:0] mem_6[16:0];
reg [127:0] mem_7[16:0];
reg [127:0] mem_8[16:0];


integer i;
integer k;
integer j;
integer fid;

initial
 begin
	//1st round
	mem_1[0]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001101011111;
	mem_1[1]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010001101011;
    mem_1[2]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010001011001;
	mem_1[3]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000111101;
	mem_1[4]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111000111;
	mem_1[5]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010100110110;
	mem_1[6]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100001011001;
	mem_1[7]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100010;
	mem_1[8]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001010100110;
	mem_1[9]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001110101110100;
	mem_1[10]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101001011011100;
	mem_1[11]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001011100001110110;
	mem_1[12]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100011101010110001;
	mem_1[13]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001010101001101111100;
	mem_1[14]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010111111100110110111;
	mem_1[15]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111101101110111111000;
	mem_1[16]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010111010101010110000000;
	//2nd round
	mem_2[0]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101011001;
	mem_2[1]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101011011;
	mem_2[2]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100111100;
	mem_2[3]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101101111;
	mem_2[4]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110101101;
	mem_2[5]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001101011;
	mem_2[6]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001;
	mem_2[7]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100001000010;
	mem_2[8]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101110011000;
	mem_2[9]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010001010110110;
	mem_2[10]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101000011001110;
	mem_2[11]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000010001101010;
	mem_2[12]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011011100001111011;
	mem_2[13]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001010101000101101111;
	mem_2[14]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100010011010110101101;
	mem_2[15]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111110001110001101100;
	mem_2[16]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010111010011111010100010;
	//3rd round
	mem_3[0]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000011100110110101111110;
	mem_3[1]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000011011111000110100010;
	mem_3[2]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000100100110111001000101;
	mem_3[3]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110100100110110110001100;
	mem_3[4]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110100011111001001011110;
	mem_3[5]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101111011111001010111000;
	mem_3[6]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000011101000101011110011;
	mem_3[7]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101111100110100100111011;
	mem_3[8]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000011100110010000000111;
	mem_3[9]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000011101100001100101111;
	mem_3[10]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000100101110010101001011;
	mem_3[11]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000011110111010100001001;
	mem_3[12]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101110101110011010110101;
	mem_3[13]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101101101010000110010000;
	mem_3[14]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111001111101011001100110;
	mem_3[15]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011100111011110000010100;
	mem_3[16]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001110000111100100000011;
	//4th round
	mem_4[0]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011101011100000111001010;
	mem_4[1]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100101100100000110111001;
	mem_4[2]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100101011010111010000000;
	mem_4[3]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011101100010111001011110;
	mem_4[4]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100101100011001000001011;
	mem_4[5]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011110000100000100110000;
	mem_4[6]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101000000100010010110010;
	mem_4[7]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011101011010011101101001;
	mem_4[8]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100101100100110011101010;
	mem_4[9]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011110001000001101011000;
	mem_4[10]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101000001010010101100111;
	mem_4[11]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011100111010110001000001;
	mem_4[12]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011100101010011100011001;
	mem_4[13]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100010101111100110011110;
	mem_4[14]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101011010111100010011101;
	mem_4[15]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110100110101110100011011;
	mem_4[16]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011000011011011010111;
	//5th round
	mem_5[0]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101111100001001100;
	mem_5[1]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110011011000111000;
	mem_5[2]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101111011001100001;
	mem_5[3]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000011010110100111;
	mem_5[4]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101111100010011101;
	mem_5[5]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000011010011101101;
	mem_5[6]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110100010001011001;
	mem_5[7]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110010110110000111;
	mem_5[8]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101110011100011011;
	mem_5[9]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101011111110110100;
	mem_5[10]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100111110111111111;
	mem_5[11]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001010100101001100100;
	mem_5[12]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001100000011011000;
	mem_5[13]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000100000010001001;
	mem_5[14]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101100010001101111101;
	mem_5[15]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001011100000101001100010;
	mem_5[16]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011011000100000011101110;
	//6th round
	mem_6[0]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111000011110101101;
	mem_6[1]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100110110011110101110;
	mem_6[2]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101000110100110011011;
	mem_6[3]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101000110101001010101;
	mem_6[4]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101000101111101011000;
	mem_6[5]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101000110101100001100;
	mem_6[6]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101000110011000111000;
	mem_6[7]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101001000001101010101;
	mem_6[8]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011110111100011010110;
	mem_6[9]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100110100100010100101;
	mem_6[10]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101000001001111101111;
	mem_6[11]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011100110011000100000;
	mem_6[12]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000001100111100100101;
	mem_6[13]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111001000000110111111;
	mem_6[14]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100010010010000001;
	mem_6[15]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010011100100000100001010;
	mem_6[16]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011110110110001100011101;
	//7th round
	mem_7[0]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111111111101111;
	mem_7[1]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001010101001101010;
	mem_7[2]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001010101001100110;
	mem_7[3]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111111111010110;
	mem_7[4]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001010101100001111;
	mem_7[5]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001010101000000101;
	mem_7[6]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001010110011100110;
	mem_7[7]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001010010010101011;
	mem_7[8]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111010111010011;
	mem_7[9]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000011011011110;
	mem_7[10]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100010110010111;
	mem_7[11]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000101010101;
	mem_7[12]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101110111101101001;
	mem_7[13]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010001010001010101010;
	mem_7[14]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100101001001100001110;
	mem_7[15]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001010100101100100111110;
	mem_7[16]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011001101001101110000110;
	//8th round
	mem_8[0]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110000101110111010011010;
	mem_8[1]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000110010111001111111;
	mem_8[2]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000101110111010010100;
	mem_8[3]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101101000011001001101000;
	mem_8[4]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110000110010111100011010;
	mem_8[5]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110001000011001110000010;
	mem_8[6]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101011110100000010101010;
	mem_8[7]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101011101110101000111001;
	mem_8[8]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000001000001101101011011;
	mem_8[9]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110000111000010011000000;
	mem_8[10]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101011110111111001001001;
	mem_8[11]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000001010100010101011011;
	mem_8[12]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000001011111100101110010;
	mem_8[13]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000100000010011010110111;
	mem_8[14]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000001011011011010;
	mem_8[15]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010111011000101110001101;
	mem_8[16]=128'b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001010010011011101100000;

	fid = $fopen("D:/FPGA learning/ModelSim/obfus(128bit)/AES/AES_fibonacci_avalanche.log");
	$display("*****************************************************");
	$display("* AES Fibonacci Testbench ...");
	$display("*****************************************************");
	$display("\n");	
	for(i=0; i<8; i=i+1)
	begin
		kld = 0;
		clk = 0;
		rst = 0;
		repeat(4)	@(posedge clk);	
		rst = 1;
		sel = 1;
		repeat(20)	@(posedge clk);

   		@(posedge clk);
   		#1;
   		kld = 1;
   		ld  = 1;
   		key    =128'h0123456789abcdef0123456789abcdef;
		
		if(i==0) 
			text_in = mem_1[0];
		if(i==1) 
			text_in = mem_2[0];
		if(i==2) 
			text_in = mem_3[0];
		if(i==3) 
			text_in = mem_4[0];
		if(i==4) 
			text_in = mem_5[0];
		if(i==5) 
			text_in = mem_6[0];
		if(i==6) 
			text_in = mem_7[0];
		if(i==7) 
			text_in = mem_8[0];
		
		
		@(posedge clk);
   		#1; 
   		kld = 0;
   		ld=0;
    	@(posedge clk);
    	while(!done)	@(posedge clk);
   
		$fdisplay(fid, "input: %b, output: %b\n", text_in, text_out);
		$fdisplay(fid, "Test Done. ");	
		repeat(10)	@(posedge clk);

		$fdisplay(fid, "++++++++++++++++++ Test avalanche effect  (fibonacci) ++++++++++++++++++++");	
		
		base_output = text_out;
		for(j=1; j<17; j=j+1)
		begin
			kld = 0;
			clk = 0;
			rst = 0;
			repeat(4)	@(posedge clk);	
			rst = 1;
			sel = 1;
			repeat(20)	@(posedge clk);

			@(posedge clk);
   			#1;
   			kld = 1;
   			ld  = 1;
			key    =  128'h0123456789abcdef0123456789abcdef;	
			if(i==0) 
				text_in = mem_1[j];
			if(i==1) 
				text_in = mem_2[j];
			if(i==2) 
				text_in = mem_3[j];
			if(i==3) 
				text_in = mem_4[j];
			if(i==4) 
				text_in = mem_5[j];
			if(i==5) 
				text_in = mem_6[j];
			if(i==6) 
				text_in = mem_7[j];
			if(i==7) 
				text_in = mem_8[j];

			@(posedge clk);
   			#1; 
   			kld = 0;
   			ld=0;
    		@(posedge clk);
   			while(!done)	@(posedge clk);   
			$fdisplay(fid,"input: %b, output: %b", text_in, text_out);

			temp = text_out^base_output;
			cnt = 8'b0;
			for(k=0; k<128; k=k+1)
			begin
				if(temp[k]!=0) cnt=cnt+1;
			end
			$fdisplay(fid,"xor:%b, cnt:%d\n", temp, cnt);	
		
		end
	end

	
	$fclose();
	$stop;
 end
 
 always #5 clk = ~clk;
	
aes_top u1(
.clk	(   clk     ), 
.rst	(   rst     ), 
.kld	(   kld     ), 
.sel	(   sel     ),
.ld 	(   ld      ), 
.done   (   done    ), 
.key	(   key     ), 
.text_in(   text_in ), 
.text_out(  text_out) 
);
endmodule